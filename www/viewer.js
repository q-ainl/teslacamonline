/* /srv/teslacam.online/viewer.script.phlo */
const $$=(s,r=document)=>r.querySelector(s), $$$=(s,r=document)=>Array.from(r.querySelectorAll(s)), el=(t,a={},...k)=>{const n=document.createElement(t);for(const [p,v] of Object.entries(a)){if(p==='class')n.className=v;else if(p==='style')n.style.cssText=v;else if(p.startsWith('on')&&typeof v==='function')n.addEventListener(p.slice(2),v);else if(p==='dataset'){for(const [dk,dv] of Object.entries(v))n.dataset[dk]=dv}else n.setAttribute(p,v)}k.forEach(x=>n.append(x));return n};
const fmtDate=d=>new Intl.DateTimeFormat('en-GB',{dateStyle:'medium'}).format(d), fmtTime=d=>new Intl.DateTimeFormat('en-GB',{hour:'2-digit',minute:'2-digit',second:'2-digit'}).format(d);
function fmtDateTime(d){return fmtDate(d)+' '+fmtTime(d)}
function fmtRate(x){const r=Number(x);if(!isFinite(r))return'1×';return (Math.round(r*100)/100).toString().replace(/(\.\d*[1-9])0+$/,'$1').replace(/\.0$/,'')+'×'}
const camOrder=['front','back','left_repeater','right_repeater'], cameraIndexMap={0:'front',3:'left_repeater',4:'right_repeater',7:'back'};
const camLabels={front:'front',left_repeater:'left',right_repeater:'right',back:'back'};
const SRC_BY_FOLDER={'recentclips':'Recent','savedclips':'Saved','sentryclips':'Sentry'};
const FILE_RE=/(\d{4}-\d{2}-\d{2})_(\d{2}-\d{2}-\d{2})-(front|left_repeater|right_repeater|back)\.(mp4|MP4)$/;
const reasonMapExact={'sentry_aware_object_detection':'Object','user_interaction_dashcam_icon_tapped':'Saved','user_interaction_dashcam_panel_save':'Saved','user_interaction_honk':'Horn','vehicle_auto_emergency_braking':'Braking'};
const reasonPrefixes=[['sentry_aware_accel_','Accel'],['sentry_','Sentry'],['user_interaction_','User action']];
const reasonLabel=r=>{if(!r)return'';if(reasonMapExact[r])return reasonMapExact[r];for(const [pre,label] of reasonPrefixes){if(r.startsWith(pre))return label}return r};
let clipSets=[],current=null,playing=false,syncing=false,scrubbing=false,scrubWasPlaying=false,layout='quad',focusCam='front',sortDir='desc',citySet=new Set(),citySelected='',geoFilter=null,brightness=1,contrast=1,rootError='';
let rafId=null,clockBase=0,clockStart=0,userTouchedZoom=false;
const MAP_CLICK_KM=0.75, ZOOM_IN_LEVEL=15;
const PL={cache:new Map()}, RT={cams:new Map()};
const R={sidebar:$$('#sidebar'),menuBtn:$$('#menuBtn'),openBtn:$$('#openBtn'),dirInput:$$('#dirInput'),list:$$('#list'),grid:$$('#grid'),thumbRow:$$('#thumbRow'),playBtn:$$('#playBtn'),speed:$$('#speed'),speedBadge:$$('#speedBadge'),bri:$$('#bri'),con:$$('#con'),scrubber:$$('#scrubber'),scrubMarks:$$('#scrubMarks'),tStart:$$('#tStart'),tEnd:$$('#tEnd'),dateBig:$$('#dateBig'),timeBig:$$('#timeBig'),locBig:$$('#locBig'),mSource:$$('#mSource'),mReason:$$('#mReason'),citySelect:$$('#citySelect'),sortToggle:$$('#sortToggle'),locBtn:$$('#locBtn'),mapWrap:$$('#mapWrap'),map:$$('#map'),mapToggle:$$('#mapToggle'),settingsBtn:$$('#settingsBtn'),settings:$$('#settings'),controls:$$('#controls'),clearArea:$$('#clearArea'),filterBar:$$('#filterBar')};
R.menuBtn.addEventListener('click',()=>R.sidebar.classList.toggle('open'));
document.addEventListener('click',e=>{if(window.innerWidth>900)return;const inside=e.target.closest('#sidebar');const onBtn=e.target.closest('#menuBtn');if(!inside&&!onBtn)R.sidebar.classList.remove('open')});
R.openBtn.addEventListener('click',()=>R.dirInput.click());
R.dirInput.addEventListener('change',async e=>{const res=await scanFiles(e.target.files);rootError=res.error||'';clipSets=res.sets||[];if(rootError){R.list.classList.add('visible');R.controls.classList.remove('visible');R.filterBar.classList.remove('visible');R.list.innerHTML='<p class="no-data">'+rootError+'</p>';return}populateCities();buildVideos();renderList();showAppUI(true);if(clipSets.length)openSet(clipSets[0],true,'list')});
function showAppUI(loaded){R.list.classList.toggle('visible',loaded);R.controls.classList.toggle('visible',loaded);R.filterBar.classList.toggle('visible',loaded)}
R.settingsBtn.addEventListener('click',()=>{const on=R.settings.classList.toggle('visible');R.settingsBtn.classList.toggle('active',on)});
R.playBtn.addEventListener('click',()=>playing?pauseAll():playAll());
R.speed.addEventListener('input',()=>{const rate=Number(R.speed.value)||1;R.speedBadge.textContent=fmtRate(rate);videos().forEach(v=>{if(!v.src)return;v.playbackRate=rate;if(playing&&v.paused)v.play().catch(()=>{})});if(playing){clockBase=Number(R.scrubber.value);clockStart=performance.now()}});
R.bri.addEventListener('input',()=>{brightness=Number(R.bri.value);applyVideoFilters()});
R.con.addEventListener('input',()=>{contrast=Number(R.con.value);applyVideoFilters()});
R.scrubber.addEventListener('pointerdown',()=>{scrubWasPlaying=playing;scrubbing=true;if(playing)pauseAll()});
R.scrubber.addEventListener('pointerup',()=>{scrubbing=false;if(scrubWasPlaying)playAll()});
R.scrubber.addEventListener('keydown',e=>{const k=e.key;if(k!=='ArrowLeft'&&k!=='ArrowRight'&&k!=='Home'&&k!=='End'&&k!=='PageUp'&&k!=='PageDown')return;e.preventDefault();const min=Number(R.scrubber.min||0),max=Number(R.scrubber.max||0);let v=Number(R.scrubber.value||0);const span=max-min||1,step=span/200,big=span/20;if(k==='ArrowLeft')v-=step;else if(k==='ArrowRight')v+=step;else if(k==='PageDown')v-=big;else if(k==='PageUp')v+=big;else if(k==='Home')v=min;else if(k==='End')v=max;if(v<min)v=min;if(v>max)v=max;R.scrubber.value=String(v);setGlobalTime(v,true)});
R.scrubber.addEventListener('input',()=>setGlobalTime(Number(R.scrubber.value),true));
R.sortToggle.addEventListener('click',()=>{sortDir=(sortDir==='desc'?'asc':'desc');R.sortToggle.textContent=sortDir==='desc'?'▼':'▲';renderList()});
R.citySelect.addEventListener('change',()=>{citySelected=R.citySelect.value||'';geoFilter=null;renderList()});
$$$('.srcChk').forEach(chk=>chk.addEventListener('change',e=>{const any=$$$('.srcChk').some(x=>x.checked);if(!any){e.target.checked=true;return}renderList()}));
R.locBtn.addEventListener('click',()=>{const on=R.mapWrap.classList.toggle('visible');R.locBtn.classList.toggle('active',on);if(on){const lat=current?.event?.est_lat,lon=current?.event?.est_lon;const newZ=userTouchedZoom?OSM.z:ZOOM_IN_LEVEL;if(!userTouchedZoom){const scale=2**(newZ-OSM.z);OSM.centerX*=scale;OSM.centerY*=scale}OSM.z=newZ;if(Number.isFinite(lat)&&Number.isFinite(lon))centerOn(lat,lon);renderOSM()}});
R.mapToggle.addEventListener('click',()=>{R.mapWrap.classList.toggle('expanded');renderOSM()});
R.clearArea.addEventListener('click',()=>{geoFilter=null;citySelected='';R.citySelect.value='';$$$('.srcChk').forEach(c=>c.checked=true);renderList()});
document.addEventListener('keydown',e=>{if(['INPUT','TEXTAREA','SELECT'].includes(document.activeElement.tagName))return;if(e.code==='Space'){e.preventDefault();playing?pauseAll():playAll()}});
function getKey(set){return `${set.source}|${set.id}`}
function buildVideos(){R.grid.innerHTML='';R.grid.className='';R.grid.classList.add(layout==='single'?'grid-single':'grid-quad');for(const cam of camOrder){const w=el('div',{class:'vwrap','data-cam':cam});const v=videoEl('main',cam);const preload=videoEl('preload',cam);preload.style.display='none';const label=camLabels[cam]||cam.replace('_',' ');w.append(v,el('div',{class:'vlab'},label),preload);R.grid.append(w)}applySingleLayout();applyVideoFilters()}
function videoEl(role,cam){const v=document.createElement('video');v.playsInline=true;v.muted=true;v.preload=role==='main'?'metadata':'auto';v.dataset.cam=cam;v.dataset.role=role;if(role==='main'){v.addEventListener('seeked',()=>syncTo(v.currentTime,v));v.addEventListener('ended',()=>{});v.addEventListener('click',()=>toggleFocus(cam))}return v}
function applyVideoFilters(){const f=`brightness(${brightness}) contrast(${contrast})`;videos().forEach(v=>{v.style.filter=f})}
function orderForSingle(){const focusW=$$(`.vwrap[data-cam="${focusCam}"]`,R.grid);if(focusW)R.grid.prepend(focusW)}
function applySingleLayout(){const small=window.innerWidth<=900;R.grid.classList.toggle('grid-single',layout==='single');R.grid.classList.toggle('grid-quad',layout!=='single');if(layout==='single'){orderForSingle()}else{const map=new Map();$$$('.vwrap',R.grid).forEach(w=>map.set(w.getAttribute('data-cam'),w));camOrder.forEach(cam=>{const w=map.get(cam);if(w)R.grid.appendChild(w)})}$$$('.vwrap',R.grid).forEach(w=>{const cam=w.getAttribute('data-cam');w.classList.toggle('focus',layout==='single'&&cam===focusCam);w.classList.toggle('side',layout==='single'&&cam!==focusCam)});const row=R.thumbRow;if(layout==='single'&&small&&row){row.innerHTML='';$$$('.vwrap',R.grid).forEach(w=>{const cam=w.getAttribute('data-cam');if(cam!==focusCam){const c=w.cloneNode(true);const v=c.querySelector('video[data-role="main"]');if(v){v.removeAttribute('src');v.load()}const lab=c.querySelector('.vlab');if(lab)lab.style.fontSize='.8rem';c.addEventListener('click',()=>toggleFocus(cam));row.appendChild(c)}})}else if(row){row.innerHTML=''}}
function toggleFocus(cam){if(layout==='quad'){layout='single';focusCam=cam;applySingleLayout()}else{if(cam===focusCam){layout='quad';applySingleLayout()}else{focusCam=cam;applySingleLayout()}}}
function videos(){return $$$('video[data-role="main"]',R.grid)}
function syncTo(t,origin){if(syncing)return;syncing=true;const max=.1;videos().forEach(v=>{if(v===origin||!v.src)return;if(Math.abs(v.currentTime-t)>max)v.currentTime=t});syncing=false}
function playAll(){playing=true;clockBase=Number(R.scrubber.value||0);clockStart=performance.now();const rate=Number(R.speed.value)||1;R.speedBadge.textContent=fmtRate(rate);videos().forEach(v=>{if(v.src){v.playbackRate=rate;v.play().catch(()=>{})}});tick();R.playBtn.textContent='⏸'}
function pauseAll(){playing=false;if(rafId){cancelAnimationFrame(rafId);rafId=null}videos().forEach(v=>v.pause());R.playBtn.textContent='▶'}
function tick(){if(!playing){rafId=null;return}const now=performance.now();const rate=Number(R.speed.value)||1;let t=clockBase+(now-clockStart)/1000*rate;setGlobalTime(t,false);rafId=requestAnimationFrame(tick)}
function setGlobalTime(t,force){const pl=PL.cache.get(getKey(current));if(!pl)return;const total=pl.totalMin||pl.totalMax||0;t=Math.max(0,Math.min(t,total));if(force){clockBase=t;clockStart=performance.now()}R.scrubber.value=String(t);updateAbsDate();const hardSeek=force||scrubbing||!playing;const rate=Number(R.speed.value)||1;for(const cam of camOrder){const ctl=pl.byCam[cam];const mv=mainVideo(cam);const pv=preloadVideo(cam);if(!mv||!ctl)continue;if(!ctl.segs.length){mv.removeAttribute('src');mv.load();pv.removeAttribute('src');pv.load();continue}const clippedT=Math.min(t,ctl.total);const found=findSegAtTime(ctl,clippedT);const state=RT.cams.get(cam)||{segIdx:0,nextIdx:null};if(state.segIdx!==found.idx||!mv.src){state.segIdx=found.idx;mv.src=ctl.segs[found.idx].src;mv.load();mv.addEventListener('loadedmetadata',()=>{mv.currentTime=found.local;if(playing&&!scrubbing){mv.playbackRate=rate;mv.play().catch(()=>{})}},{once:true});pv.removeAttribute('src');pv.load();pv.dataset.srcKey='';state.nextIdx=null}else{const max=.08;if(hardSeek&&Math.abs(mv.currentTime-found.local)>max)mv.currentTime=found.local}const dur=isFinite(mv.duration)?mv.duration:0;const remain=dur>0?dur-mv.currentTime:999;if(remain<.35){const nextIdx=state.segIdx+1;if(nextIdx<ctl.segs.length){const nextSrc=ctl.segs[nextIdx].src;if(pv.dataset.srcKey!==nextSrc){pv.src=nextSrc;pv.load();pv.dataset.srcKey=nextSrc;state.nextIdx=nextIdx}}}if(state.nextIdx!=null&&clippedT>=(ctl.cum[state.nextIdx-1]||0)){mv.src=pv.src;mv.load();mv.currentTime=0;pv.removeAttribute('src');pv.load();pv.dataset.srcKey='';state.segIdx=state.nextIdx;state.nextIdx=null;if(playing&&!scrubbing){mv.playbackRate=rate;mv.play().catch(()=>{})}}RT.cams.set(cam,state)}}
function initTimeline(){}
function updateAbsDate(){if(!current)return;const pl=PL.cache.get(getKey(current));const base=pl?.startDate||baseDate(current)||new Date();const t=Number(R.scrubber.value||0);const now=new Date(base.getTime()+t*1000);R.dateBig.textContent=fmtDate(now);R.timeBig.textContent=fmtTime(now);R.locBig.textContent=current?.event?.city||''}
function renderScrubMarks(){const pl=PL.cache.get(getKey(current));if(!pl){R.scrubMarks.innerHTML='';return}const total=pl.totalMin||pl.totalMax||0;let html='';for(const cam of camOrder){const ctl=pl.byCam[cam];if(!ctl)continue;for(let i=0;i<ctl.cum.length-1;i++){const x=ctl.cum[i]/total*100;html+=`<span class="scrubMark" style="left:${x}%;"></span>`}}R.scrubMarks.innerHTML=html}
function normalizePath(p){return(p||'').replace(/\\/g,'/')}
function parseIdToDate(id){const m=/^(\d{4}-\d{2}-\d{2})_(\d{2}-\d{2}-\d{2})$/.exec(id);if(!m)return null;const[Y,M,D]=m[1].split('-').map(Number),[h,mi,s]=m[2].split('-').map(Number);return new Date(Y,M-1,D,h,mi,s)}
function parseDT(date,time){if(!date||!time)return null;const[Y,M,D]=date.split('-').map(Number),[h,mi,s]=time.split('-').map(Number);return new Date(Y,M-1,D,h,mi,s)}
function idToDate(date,time){if(!date||!time)return null;const[Y,M,D]=date.split('-').map(Number),[h,mi,s]=time.split('-').map(Number);return new Date(Y,M-1,D,h,mi,s)}
function baseDate(set){const byId=parseIdToDate(set.id);if(byId)return byId;let min=null;for(const cam of camOrder){const arr=set.files[cam];if(!arr)continue;for(const f of arr){const d=parseDT(f.date,f.time);if(d&&(!min||d<min))min=d}}return min}
function parseEventEnd(ts){if(!ts)return null;const d=new Date(ts);return isNaN(d)?null:d}
async function scanFiles(fileList){const files=Array.from(fileList||[]);if(!files.length)return{sets:[],error:'No files selected.'};const setsMap=new Map(),thumbs=new Map();citySet.clear();let hasRecent=false,hasSaved=false,hasSentry=false;for(const f of files){const path=normalizePath(f.webkitRelativePath||f.name),parts=path.split('/');if(parts.length<2)continue;const root=parts[1]?.toLowerCase();if(root==='recentclips')hasRecent=true;if(root==='savedclips')hasSaved=true;if(root==='sentryclips')hasSentry=true;const src=SRC_BY_FOLDER[root];if(!src)continue;if(path.toLowerCase().endsWith('thumb.png')){if(parts.length>=3&&(src==='Sentry'||src==='Saved'))thumbs.set(`${src}|${parts[2]}`,URL.createObjectURL(f));else if(src==='Recent')thumbs.set('Recent|__',URL.createObjectURL(f))}}if(!(hasRecent&&hasSaved&&hasSentry))return{sets:[],error:'The selected folder does not look like a TeslaCam root. Make sure it contains RecentClips, SavedClips and SentryClips.'};for(const f of files){const path=normalizePath(f.webkitRelativePath||f.name),parts=path.split('/');if(parts.length<2)continue;const src=SRC_BY_FOLDER[parts[1]?.toLowerCase()];if(!src)continue;if(path.toLowerCase().endsWith('event.json')&&parts.length>=3){const key=`${src}|${src==='Recent'?'RecentClips':parts[2]}`,text=await f.text().catch(()=>null);let meta=null;try{meta=JSON.parse(text)}catch{}const set=setsMap.get(key)??{id:(src==='Recent'?'RecentClips':parts[2]),source:src,files:{},event:null,thumb:thumbs.get(key)||thumbs.get('Recent|__')};if(meta){set.event={timestamp:meta.timestamp,city:meta.city,est_lat:meta.est_lat!=null?Number(meta.est_lat):undefined,est_lon:meta.est_lon!=null?Number(meta.est_lon):undefined,reason:meta.reason,camera:meta.camera};if(set.event.city)citySet.add(set.event.city)}setsMap.set(key,set);continue}const base=(path.split('/').pop()||'');if(FILE_RE.test(base)){const[,date,time,cam]=base.match(FILE_RE);if(src==='Sentry'||(src==='Saved'&&parts.length>=4)){const key=`${src}|${parts[2]}`,url=URL.createObjectURL(f);const set=setsMap.get(key)??{id:parts[2],source:src,files:{},event:null,thumb:thumbs.get(key)};set.files[cam]=set.files[cam]||[];set.files[cam].push({src:url,date,time,dt:idToDate(date,time),file:f,dur:null});setsMap.set(key,set)}else{const key=`Recent|RecentClips`,url=URL.createObjectURL(f);const set=setsMap.get(key)??{id:'RecentClips',source:'Recent',files:{},event:null,thumb:thumbs.get('Recent|__')};set.files[cam]=set.files[cam]||[];set.files[cam].push({src:url,date,time,dt:idToDate(date,time),file:f,dur:null});setsMap.set(key,set)}}}const arr=[...setsMap.values()].sort((a,b)=>b.id.localeCompare(a.id));return{sets:arr,error:''}}
function populateCities(){const sel=R.citySelect;const vals=[...citySet].sort((a,b)=>a.localeCompare(b));sel.innerHTML='<option value="">All locations</option>'+vals.map(c=>`<option>${c}</option>`).join('')}
function selectedSources(){return $$$('.srcChk').filter(x=>x.checked).map(x=>x.value)}
function haversineKm(lat1,lon1,lat2,lon2){const Rk=6371,toRad=d=>d*Math.PI/180;const dLat=toRad(lat2-lat1),dLon=toRad(lon2-lon1);const a=Math.sin(dLat/2)**2+Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;return 2*Rk*Math.asin(Math.sqrt(a))}
function passFilters(set){if(selectedSources().length&&!selectedSources().includes(set.source))return false;if(citySelected){if((set.event?.city||'')!==citySelected)return false}if(geoFilter){const ev=set.event;if(!ev||isNaN(ev.est_lat)||isNaN(ev.est_lon))return false;if(haversineKm(geoFilter.lat,geoFilter.lon,ev.est_lat,ev.est_lon)>geoFilter.km)return false}return true}
function anyFilterActive(){if(citySelected)return true;if(geoFilter)return true;const all=$$$('.srcChk');if(!all.length)return false;return all.some(c=>!c.checked)}
function clearAllFilters(){citySelected='';geoFilter=null;R.citySelect.value='';$$$('.srcChk').forEach(c=>c.checked=true)}
function renderList(){let items=clipSets.filter(passFilters);items.sort((a,b)=>sortDir==='asc'?a.id.localeCompare(b.id):b.id.localeCompare(a.id));R.list.innerHTML='';if(anyFilterActive()){const back=el('div',{class:'item',onclick:()=>{clearAllFilters();renderList();R.list.scrollTop=0}},el('div',{class:'info'},el('div',{class:'topline'},el('span',{},'Show full list'),el('span',{},'')),el('div',{class:'sub'},'Remove filters and show all')));R.list.append(back)}if(!items.length){R.list.innerHTML+='<p class="no-data">No clips match your filters.</p>';return}for(const set of items){const d=baseDate(set);const dt=d?fmtDateTime(d):'';const city=set.event?.city||'';const reason=reasonLabel(set.event?.reason)||'';const row=el('div',{class:'item',dataset:{key:getKey(set)},onclick:()=>openSet(set,true,'list')});const img=el('img',{alt:'thumb',width:96,height:72});if(set.thumb)img.src=set.thumb;const top=[set.source,dt].filter(Boolean).join(' · ');const sub=[city,reason].filter(Boolean).join(' — ');const info=el('div',{class:'info'},el('div',{class:'topline'},el('span',{},top),el('span',{},'')),el('div',{class:'sub'},sub));row.append(img,info);if(current===set)row.classList.add('active');R.list.append(row)}}
async function openSet(e,t,a){current=e,renderList();const n=await buildPlaylistsForSet(e),s=new Map(videos().map(v=>[v.dataset.cam,v]));RT.cams.clear();for(const cam of camOrder){const v=s.get(cam),ctl=n.byCam[cam];v.pause();v.removeAttribute("src");v.load();preloadVideo(cam).removeAttribute('src');preloadVideo(cam).load();RT.cams.set(cam,{segIdx:0,playing:!1,nextIdx:null});if(ctl.segs.length){v.src=ctl.segs[0].src;v.load()}}const i=Number(e.event?.camera);Number.isFinite(i)&&0!==i?(focusCam=cameraIndexMap[i]||"front",layout="single"):layout="quad";applySingleLayout();applyVideoFilters();const scrubMax=n.totalMin||n.totalMax||0;R.scrubber.max=String(scrubMax);R.scrubber.value="0";renderScrubMarks();const o=n.startDate||baseDate(e)||new Date,r=n.endDate||new Date(o.getTime()+1e3*(n.totalMax||0));R.tStart.textContent=fmtTime(o);R.tEnd.textContent=fmtTime(r);R.dateBig.textContent=fmtDate(o);R.timeBig.textContent=fmtTime(o);R.locBig.textContent=e?.event?.city||"";const l=Number(R.speed.value)||1;R.speedBadge.textContent=fmtRate(l);videos().forEach(v=>v.playbackRate=l);t?playAll():pauseAll();updateMetaAndMap();("list"===a||"map"===a)&&R.mapWrap.classList.contains("visible")&&(()=>{const lat=e?.event?.est_lat,lon=e?.event?.est_lon;if(Number.isFinite(lat)&&Number.isFinite(lon)){if(!userTouchedZoom)OSM.z=ZOOM_IN_LEVEL;centerOn(lat,lon);renderOSM()}})()}
function updateMetaAndMap(){if(!current){R.mSource.textContent='';R.mReason.textContent='';R.mReason.style.display='none';R.dateBig.textContent='—';R.timeBig.textContent='—:—:—';R.locBig.textContent='';return}R.mSource.textContent=current.source||'';const rtxt=current.event?.reason?reasonLabel(current.event.reason):'';R.mReason.textContent=rtxt;R.mReason.style.display=rtxt?'inline':'none';const d=baseDate(current);R.dateBig.textContent=d?fmtDate(d):'—';R.locBig.textContent=current.event?.city||'';if(R.mapWrap.classList.contains('visible')){const lat=current.event?.est_lat,lon=current.event?.est_lon;if(Number.isFinite(lat)&&Number.isFinite(lon)){centerOn(lat,lon);renderOSM()}}}
async function buildPlaylistsForSet(t){const e=getKey(t);if(PL.cache.has(e))return PL.cache.get(e);const n={};let a=null,c=null;for(const cam of camOrder){const s=(t.files[cam]||[]).slice().sort((t,e)=>(t.dt||0)-(e.dt||0));n[cam]={segs:s,cum:[],total:0};for(const seg of s){seg.dur=await ensureDuration(seg);const prev=n[cam].cum.length?n[cam].cum[n[cam].cum.length-1]:0;n[cam].cum.push(prev+seg.dur);n[cam].total+=seg.dur;if(seg.dt){(!a||seg.dt<a)&&(a=seg.dt);const end=new Date(seg.dt.getTime()+1e3*seg.dur);(!c||end>c)&&(c=end)}}}const eventEnd=parseEventEnd(t?.event?.timestamp)||c||null;const totals=Object.values(n).map(x=>x.total).filter(x=>x>0);const totalMax=totals.length?Math.max(...totals):0;const totalMin=totals.length?Math.min(...totals):0;const res={byCam:n,totalMax,totalMin,startDate:eventEnd&&totalMax>0?new Date(eventEnd.getTime()-1e3*totalMax):a||null,endDate:eventEnd};PL.cache.set(e,res);return res}
function ensureDuration(seg){return new Promise(resolve=>{if(Number.isFinite(seg.dur)&&seg.dur>0)return resolve(seg.dur);const v=document.createElement('video');v.preload='metadata';v.src=seg.src;const done=()=>{const d=(isFinite(v.duration)&&v.duration>0)?v.duration:60;v.src='';v.remove();seg.dur=d;resolve(d)};v.addEventListener('loadedmetadata',done,{once:true});v.addEventListener('error',done,{once:true})})}
function findSegAtTime(ctl,t){const {cum,segs}=ctl;if(!segs.length)return{idx:-1,local:0};if(t<=0)return{idx:0,local:0};for(let i=0;i<cum.length;i++){if(t<=cum[i]){const prev=i?cum[i-1]:0;return{idx:i,local:t-prev}}}return{idx:segs.length-1,local:(segs[segs.length-1].dur||0)}}
const OSM={size:256,z:5,centerX:0,centerY:0,drag:false,px:0,py:0}, osmRoot='https://tile.openstreetmap.org';
function ll2tile(lat,lon,z){const n=2**z,xt=(lon+180)/360*n,latRad=lat*Math.PI/180,yt=(1-Math.log(Math.tan(latRad)+1/Math.cos(latRad))/Math.PI)/2*n;return[xt,yt]}
function tile2ll(x,y,z){const n=2**z;const lon=x/n*360-180;const rad=Math.atan(Math.sinh(Math.PI*(1-2*y/n)));const lat=rad*180/Math.PI;return[lat,lon]}
function centerOn(lat,lon){const[xt,yt]=ll2tile(lat,lon,OSM.z);OSM.centerX=xt*OSM.size;OSM.centerY=yt*OSM.size}
function getMarkers(){const pts=[];for(const s of clipSets){const ev=s.event;if(!ev||isNaN(ev?.est_lat)||isNaN(ev?.est_lon))continue;const cls=s.source==='Sentry'?'sentry':s.source==='Recent'?'recent':'saved';pts.push({lat:ev.est_lat,lon:ev.est_lon,cls,key:getKey(s),set:s})}return pts}
function renderOSM(){if(!R.mapWrap.classList.contains('visible'))return;const wrap=R.map;let tiles=$$('#osmTiles',wrap),marks=$$('#osmMarks',wrap);if(!tiles){tiles=el('div',{id:'osmTiles'});marks=el('div',{id:'osmMarks'});wrap.innerHTML='';wrap.append(tiles,marks);wireOSM(wrap)}const rect=wrap.getBoundingClientRect(),w=rect.width,h=rect.height;const originX=OSM.centerX-w/2,originY=OSM.centerY-h/2;tiles.innerHTML='';const sx=Math.floor(originX/OSM.size),sy=Math.floor(originY/OSM.size),ex=Math.floor((originX+w)/OSM.size),ey=Math.floor((originY+h)/OSM.size),n=2**OSM.z;for(let ty=sy-1;ty<=ey+1;ty++){for(let tx=sx-1;tx<=ex+1;tx++){let x=((tx%n)+n)%n;if(ty<0||ty>=n)continue;const img=new Image();img.referrerPolicy='no-referrer';img.draggable=false;img.src=`${osmRoot}/${OSM.z}/${x}/${ty}.png`;img.style.position='absolute';img.style.left=Math.round(tx*OSM.size-originX)+'px';img.style.top=Math.round(ty*OSM.size-originY)+'px';img.width=OSM.size;img.height=OSM.size;tiles.appendChild(img)}}marks.innerHTML='';const pts=getMarkers();const originX2=OSM.centerX-w/2,originY2=OSM.centerY-h/2;for(const p of pts){const[xt,yt]=ll2tile(p.lat,p.lon,OSM.z);const px=xt*OSM.size-originX2,py=yt*OSM.size-originY2;const m=el('button',{type:'button',class:`marker ${p.cls}${current&&getKey(current)===p.key?' active':''}`,style:`left:${px-10}px;top:${py-10}px`,dataset:{key:p.key}});m.addEventListener('click',ev=>{ev.stopPropagation();onMapMarkerClick(p.set,true)});m.addEventListener('pointerup',ev=>{ev.stopPropagation();onMapMarkerClick(p.set,true)});marks.appendChild(m)}marks.onclick=e=>{if(e.target.classList.contains('marker'))return;const r=marks.getBoundingClientRect();const cx=e.clientX-r.left,cy=e.clientY-r.top;const latlon=screenToLatLon(cx,cy,r);const nearest=findNearestPoint(latlon.lat,latlon.lon,pts);if(nearest&&nearest.distKm<=MAP_CLICK_KM){onMapMarkerClick(nearest.set,true)}}}
function wireOSM(wrap){wrap.addEventListener('wheel',e=>{e.preventDefault();const rect=wrap.getBoundingClientRect(),cx=e.clientX-rect.left,cy=e.clientY-rect.top;const originX=OSM.centerX-rect.width/2,originY=OSM.centerY-rect.height/2;const wx=originX+cx,wy=originY+cy;const newZ=Math.max(2,Math.min(18,OSM.z-Math.sign(e.deltaY)));if(newZ===OSM.z)return;const scale=2**(newZ-OSM.z);OSM.z=newZ;userTouchedZoom=true;const nOX=wx*scale-cx,nOY=wy*scale-cy;OSM.centerX=nOX+rect.width/2;OSM.centerY=nOY+rect.height/2;renderOSM()},{passive:false});wrap.addEventListener('pointerdown',e=>{if(e.target.closest('.marker'))return;OSM.drag=true;OSM.px=e.clientX;OSM.py=e.clientX;wrap.setPointerCapture(e.pointerId)});wrap.addEventListener('pointermove',e=>{if(!OSM.drag)return;const dx=OSM.px-e.clientX,dy=OSM.py-e.clientY;OSM.px=e.clientX;OSM.py=e.clientY;OSM.centerX+=dx;OSM.centerY+=dy;renderOSM()});wrap.addEventListener('pointerup',()=>{OSM.drag=false});window.addEventListener('resize',()=>{if(R.mapWrap.classList.contains('visible'))renderOSM()})}
function screenToLatLon(px,py,rect){const x=(OSM.centerX-rect.width/2)+px;const y=(OSM.centerY-rect.height/2)+py;const xt=x/OSM.size,yt=y/OSM.size;const[lat,lon]=tile2ll(xt,yt,OSM.z);return{lat,lon}}
function findNearestPoint(lat,lon,pts){let best=null;for(const p of pts){const d=haversineKm(lat,lon,p.lat,p.lon);if(best==null||d<best.distKm)best={...p,distKm:d}}return best}
function onMapMarkerClick(set,autoplay){openSet(set,autoplay,'map')}
function mainVideo(cam){return $$(`video[data-role="main"][data-cam="${cam}"]`,R.grid)}
function preloadVideo(cam){return $$(`video[data-role="preload"][data-cam="${cam}"]`,R.grid)}
centerOn(52.1,5.3);
